---
title: "ARCOS demo of synthetic test cases trackCollEvents"
output:   
  rmarkdown::html_vignette:
    toc: true 
vignette: >
  %\VignetteIndexEntry{ARCOS demo of synthetic test cases trackCollEvents}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r, include = FALSE}
  knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
```

```{r setup}
#library(ARCOS)
library(data.table)
library(ggplot2)
library(ggthemes)
library(OpenImageR)

library(testthat)

lPar = list()

lPar$db.eps = 1.0
lPar$db.minPts = 1L

## Custom functions

# Wrapper function for testing
myTest = function(inDTcalc, inFtrue, inDir = "testdata") {
  
  resTest = testthat::test_that("test chunk", {
    locDTtrueRes = fread(file.path(system.file(inDir, 
                                               package="ARCOS"),
                                   inFtrue))
    attr(inDTcalc, "sorted") = NULL
    expect_equal(inDTcalc, 
                 locDTtrueRes)
  })
}

# Wrapper functions for custom plots
myPlotTile = function(inDT, 
                      inFillVar = "trackID", 
                      inFillName = "Track ID",
                      inX = "time",
                      inY = "x") {
  locP = ggplot(inDT,
                aes(x = get(inX),
                    y = as.factor(get(inY)))) +
    geom_tile(aes(fill = as.factor(get(inFillVar))), 
              colour = "grey50") +
    ggthemes::scale_fill_tableau(name = inFillName,
                                 palette = "Tableau 10") +
    xlab("Time") +
    ylab("Position")
  
  return(locP)
}

myPlotLine = function(inDT, 
                      inVarObj = "id", 
                      inVarColl = NULL,
                      inX = "time",
                      inY = "x") {
  locP = ggplot(inDT,
                aes_string(x = inX,
                           y = inY,
                           group = inVarObj,
                           color = inVarObj)) +
    geom_path() +
    scale_color_tableau(name = "Object\nid:",
                        palette = "Tableau 10") +
    xlab("Time") +
    ylab("Position") +
    theme_bw()
  
  if (is.null(inVarColl)) {
    locP = locP +
        geom_point()
  } else {
    locP = locP +
      geom_point(aes(shape = as.factor(collid)),
                 size = 3) +
      scale_shape_discrete(name = "Collective\nid:")
  }
  
  return(locP)
}

myImLoad = function(inPath) {
  vFiles = list.files(path = file.path(system.file("testImagePatterns", package="ARCOS"), inPath), 
                      pattern = "*.png", 
                      full.names = T)
  
  lIn = lapply(seq_along(vFiles), function (ii) {
    fIn = vFiles[ii]
    locMbin = OpenImageR::readImage(fIn)
    locMdown = OpenImageR::down_sample_image(locMbin, 
                                             factor = 16.0, 
                                             gaussian_blur = F)
    locM = locMdown > 0.5
    locDT = as.data.table(reshape2::melt(locM, 
                                         value.name = "m"))
    setnames(locDT, 
             c("Var1", "Var2"), 
             c("y", "x"))
    locDT[,
          m := as.numeric(m)]
    locDT[, 
          trackID := .I]
    locDT[,
          time := ii]
    
  })
  
  return(rbindlist(lIn))
}

myImPlot = function(inDT,
                     inFillVar = "m", 
                     inFillName = "Meas",
                     inFillPal = "Classic Gray 5",
                     inX = "x",
                     inY = "y",
                     inFacetVar = "time",
                     inXlim = NULL,
                     inYlim = NULL) {
  
  locP = 
    ggplot(inDT,
           aes(x = get(inX),
               y = get(inY))) +
    geom_tile(aes(fill = as.factor(get(inFillVar)))) +
    ggthemes::scale_fill_tableau(name = inFillName,
                                 palette = inFillPal) +
    facet_wrap(inFacetVar) +
    coord_fixed(ratio=1) +
    xlab("posx") +
    ylab("posy")

  if (!is.null(inXlim)) {
    locP = locP +
      scale_x_continuous(limits = inXlim)
  }
  
  if (is.null(inYlim)) {
    locP = locP +
      scale_y_continuous(trans = "reverse")
  } else {
    locP = locP +
      scale_y_reverse(limits = inYlim)
  }
  
  return(locP)
}
```


# Link 1 frame
## Test 1 - 1 central

```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "1central_in.csv"))
myPlotTile(dtIn)
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = lPar$db.eps, 
                                inMinPts = lPar$db.minPts, 
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myPlotTile(dtRes,
           "clTrackID",
           "Coll ID")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "1central_res.csv")
```

## Test 2 - 3 spreading

```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", 
                                   package="ARCOS"), 
                       "3spreading_in.csv"))

myPlotTile(dtIn[m>0])
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = lPar$db.eps, 
                                inMinPts = lPar$db.minPts, 
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myPlotTile(dtRes,
           "clTrackID",
           "Coll ID")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "3spreading_res.csv")
```

## Test 3 - 5 overlapping


```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", 
                                   package="ARCOS"), 
                       "5overlapping_in.csv"))

myPlotTile(dtIn)
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = lPar$db.eps, 
                                inMinPts = lPar$db.minPts, 
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"),
              all.x = T)

myPlotTile(dtRes,
           "clTrackID",
           "Coll ID")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "5overlapping_res.csv")
```

## Test 4 - 6 overlapping


```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", 
                                   package="ARCOS"), 
                       "6overlapping_in.csv"))

myPlotTile(dtIn)
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = lPar$db.eps, 
                                inMinPts = lPar$db.minPts, 
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"),
              all.x = T)

myPlotTile(dtRes,
           "clTrackID",
           "Coll ID")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "6overlapping_res.csv")
```

## Test 5 - 1 central growing

```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", 
                                   package="ARCOS"), 
                       "1centralGrowing_in.csv"))

myPlotTile(dtIn)
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = lPar$db.eps, 
                                inMinPts = lPar$db.minPts, 
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"),
              all.x = T)

myPlotTile(dtRes,
           "clTrackID",
           "Coll ID")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "1centralGrowing_res.csv")
```

## Test 6 - 2 central growing

```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", 
                                   package="ARCOS"), 
                       "2centralGrowing_in.csv"))

myPlotTile(dtIn)
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = lPar$db.eps, 
                                inMinPts = lPar$db.minPts, 
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"),
              all.x = T)

myPlotTile(dtRes,
           "clTrackID",
           "Coll ID")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "2centralGrowing_res.csv")
```


## Test 7 - 2 with 1 common symmetric

```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", 
                                   package="ARCOS"), 
                       "2with1commonSym_in.csv"))

myPlotTile(dtIn)
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = lPar$db.eps, 
                                inMinPts = lPar$db.minPts, 
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"),
              all.x = T)

myPlotTile(dtRes,
           "clTrackID",
           "Coll ID")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "2with1commonSym_res.csv")
```

## Test 8 - 2 with 1 common asymmetric

```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", 
                                   package="ARCOS"), 
                       "2with1commonAsym_in.csv"))

myPlotTile(dtIn)
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = lPar$db.eps, 
                                inMinPts = lPar$db.minPts, 
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"),
              all.x = T)

myPlotTile(dtRes,
           "clTrackID",
           "Coll ID")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "2with1commonAsym_res.csv")
```


# Multiple new objects

## Test 1 - simultaneous

```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "multipleSimulNewObjects_in.csv"))

myPlotLine(inDT = dtIn,
           inVarObj = "id", 
           inX = "t", 
           inY = "pos")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn, 
                                inEps = 1.1, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "t",
                                              id = "id",
                                              clid = "collid"),
                                inPosCols = c("pos"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("t", "id"))


myPlotLine(inDT = dtRes,
           inVarObj = "id", 
           inVarColl = "collid",
           inX = "t", 
           inY = "pos")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(t, id, collid)],
       "multipleSimulNewObjects_out.csv")
```

## Test 2 - 4 new objects at once after 1

```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "multipleSubseq4NewObjectsAfter1_in.csv"))

myPlotLine(inDT = dtIn,
           inVarObj = "id", 
           inX = "t", 
           inY = "pos")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn, 
                                inEps = 1.1, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "t",
                                              id = "id",
                                              clid = "collid"),
                                inPosCols = c("pos"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("t", "id"))


myPlotLine(inDT = dtRes,
           inVarObj = "id", 
           inVarColl = "collid",
           inX = "t", 
           inY = "pos")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(t, id, collid)],
       "multipleSubseq4NewObjectsAfter1_out.csv")
```

## Test 3 - 3 new objects at once after 2

```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "multipleSubseq3NewObjectsAfter2_in.csv"))

myPlotLine(inDT = dtIn,
           inVarObj = "id", 
           inX = "t", 
           inY = "pos")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn, 
                                inEps = 1.1, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "t",
                                              id = "id",
                                              clid = "collid"),
                                inPosCols = c("pos"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("t", "id"))


myPlotLine(inDT = dtRes,
           inVarObj = "id", 
           inVarColl = "collid",
           inX = "t", 
           inY = "pos")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(t, id, collid)],
       "multipleSubseq3NewObjectsAfter2_out.csv")
```


## Test 4 - 4 new objects at once after 2

```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "multipleSubseq4NewObjectsAfter2_in.csv"))

myPlotLine(inDT = dtIn,
           inVarObj = "id", 
           inX = "t", 
           inY = "pos")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn, 
                                inEps = 1.1, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "t",
                                              id = "id",
                                              clid = "collid"),
                                inPosCols = c("pos"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("t", "id"))


myPlotLine(inDT = dtRes,
           inVarObj = "id", 
           inVarColl = "collid",
           inX = "t", 
           inY = "pos")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(t, id, collid)],
       "multipleSubseq4NewObjectsAfter2_out.csv")
```


## Test 4 - 4 subsequently

```{r, echo = T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "multipleSubseqNewObjects_in.csv"))

myPlotLine(inDT = dtIn,
           inVarObj = "id", 
           inX = "t", 
           inY = "pos")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn, 
                                inEps = 1.1, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "t",
                                              id = "id",
                                              clid = "collid"),
                                inPosCols = c("pos"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("t", "id"))


myPlotLine(inDT = dtRes,
           inVarObj = "id", 
           inVarColl = "collid",
           inX = "t", 
           inY = "pos")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(t, id, collid)],
       "multipleSubseqNewObjects_out.csv")
```

# Split, cross, merge

## Test 1 - split from single

```{r, echo=T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "1objSplit_in.csv"))

myPlotLine(inDT = dtIn,
           inVarObj = "id", 
           inX = "t", 
           inY = "pos")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn, 
                                inEps = 1.1, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "t",
                                              id = "id",
                                              clid = "collid"),
                                inPosCols = c("pos"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("t", "id"))


myPlotLine(inDT = dtRes,
           inVarObj = "id", 
           inVarColl = "collid",
           inX = "t", 
           inY = "pos")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(t, id, collid)],
       "1objSplit_res.csv")
```

## Test 2 - split from 2 objects

```{r, echo=T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "2objSplit_in.csv"))

myPlotLine(inDT = dtIn,
           inVarObj = "id", 
           inX = "t", 
           inY = "pos")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn, 
                                inEps = 1.1, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "t",
                                              id = "id",
                                              clid = "collid"),
                                inPosCols = c("pos"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("t", "id"))


myPlotLine(inDT = dtRes,
           inVarObj = "id", 
           inVarColl = "collid",
           inX = "t", 
           inY = "pos")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(t, id, collid)],
       "2objSplit_res.csv")
```

## Test 3 - cross 2 objects

```{r, echo=T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "2objCross_in.csv"))

myPlotLine(inDT = dtIn,
           inVarObj = "id", 
           inX = "t", 
           inY = "pos")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn, 
                                inEps = 1.1, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "t",
                                              id = "id",
                                              clid = "collid"),
                                inPosCols = c("pos"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("t", "id"))


myPlotLine(inDT = dtRes,
           inVarObj = "id", 
           inVarColl = "collid",
           inX = "t", 
           inY = "pos")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(t, id, collid)],
       "2objCross_res.csv")
```

## Test 4 - cross 2 objects with common

```{r, echo=T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "2objCrossCommon_in.csv"))

myPlotLine(inDT = dtIn,
           inVarObj = "id", 
           inX = "t", 
           inY = "pos")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn, 
                                inEps = 1.1, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "t",
                                              id = "id",
                                              clid = "collid"),
                                inPosCols = c("pos"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("t", "id"))


myPlotLine(inDT = dtRes,
           inVarObj = "id", 
           inVarColl = "collid",
           inX = "t", 
           inY = "pos")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(t, id, collid)],
       "2objCrossCommon_res.csv")
```

## Test 5 - merge & split 2 objects with common

```{r, echo=T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "2objMergeSplitCommon_in.csv"))

myPlotLine(inDT = dtIn,
           inVarObj = "id", 
           inX = "t", 
           inY = "pos")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn, 
                                inEps = 1.1, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "t",
                                              id = "id",
                                              clid = "collid"),
                                inPosCols = c("pos"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("t", "id"))


myPlotLine(inDT = dtRes,
           inVarObj = "id", 
           inVarColl = "collid",
           inX = "t", 
           inY = "pos")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(t, id, collid)],
       "2objMergeSplitCommon_res.csv")
```

## Test 6 - merge & split 2 objects crossing

```{r, echo=T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "2objMergeSplitCross_in.csv"))

myPlotLine(inDT = dtIn,
           inVarObj = "id", 
           inX = "t", 
           inY = "pos")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn, 
                                inEps = 1.1, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "t",
                                              id = "id",
                                              clid = "collid"),
                                inPosCols = c("pos"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("t", "id"))


myPlotLine(inDT = dtRes,
           inVarObj = "id", 
           inVarColl = "collid",
           inX = "t", 
           inY = "pos")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(t, id, collid)],
       "2objMergeSplitCross_res.csv")
```

## Test 7 - merge & split 2 objects near

```{r, echo=T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "2objMergeSplitNear_in.csv"))

myPlotLine(inDT = dtIn,
           inVarObj = "id", 
           inX = "t", 
           inY = "pos")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn, 
                                inEps = 1.1, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "t",
                                              id = "id",
                                              clid = "collid"),
                                inPosCols = c("pos"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("t", "id"))


myPlotLine(inDT = dtRes,
           inVarObj = "id", 
           inVarColl = "collid",
           inX = "t", 
           inY = "pos")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(t, id, collid)],
       "2objMergeSplitNear_res.csv")
```

# Link 2 frames
## Test 1 - 1 central

```{r, echo=T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "1central_in.csv"))

myPlotTile(inDT = dtIn,
           inFillVar = "trackID",
           inFillName = "Track ID",
           inX = "time", 
           inY = "x")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = lPar$db.eps, 
                                inMinPts = lPar$db.minPts, 
                                inNprev = 2L,
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myPlotTile(dtRes,
           inFillVar = "clTrackID",
           inFillName = "Coll ID", 
           inX = "time",
           inY = "x")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "1central2prev_res.csv")
```

## Test 2 - 3 spreading

```{r, echo=T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "3spreading_in.csv"))

myPlotTile(inDT = dtIn[m>0],
           inFillVar = "trackID",
           inFillName = "Track ID",
           inX = "time", 
           inY = "x")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = lPar$db.eps, 
                                inMinPts = lPar$db.minPts, 
                                inNprev = 2L,
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myPlotTile(dtRes,
           inFillVar = "clTrackID",
           inFillName = "Coll ID", 
           inX = "time",
           inY = "x")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "3spreading2prev_res.csv")
```

## Test 3 - 5 overlapping

```{r, echo=T, fig.width=6, fig.height=5}
dtIn = fread(file.path(system.file("testdata", package="ARCOS"), "5overlapping_in.csv"))

myPlotTile(inDT = dtIn[m>0],
           inFillVar = "trackID",
           inFillName = "Track ID",
           inX = "time", 
           inY = "x")
```

```{r, echo = T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = lPar$db.eps, 
                                inMinPts = lPar$db.minPts, 
                                inNprev = 2L,
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"),
              all.x = T)

myPlotTile(dtRes,
           inFillVar = "clTrackID",
           inFillName = "Coll ID", 
           inX = "time",
           inY = "x")
```

```{r, echo = F, results="asis"}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "5overlapping2prev_res.csv")
```

# DMD tests

Test scenarios for calibration experiments using DMD.

Wave propagation loaded from images. Images are down-sampled 16 times. Each pixel in down-sampled images corresponds to a single object/cell.

## Exp 01

Detection and tracking of expansion of growing clusters.

```{r,echo=T, eval=T, fig.width=6, fig.height=5}
dtIn = myImLoad("exp01/png")

myImPlot(dtIn)
```

```{r, echo = T, eval=T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = 2, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "time",
                                              id = "trackID",
                                              clid = "clTrackID"),
                                inPosCols = c("x", "y"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myImPlot(dtRes,
          inFillVar = "clTrackID",
          inFillName = "Cluster",
          inFillPal = "Tableau 10",
          inXlim = c(min(dtIn$x), max(dtIn$x)),
          inYlim = c(max(dtIn$y), min(dtIn$y)))
```

```{r, echo = F, results="asis", eval = T}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "exp01/dmd-exp01_out.csv", 
       inDir = "testImagePatterns")
```

## Exp 02

Detection and tracking of a single expanding cluster that breaks.

```{r,echo=T, eval=T, fig.width=6, fig.height=5}
dtIn = myImLoad("exp02/png")

myImPlot(dtIn)
```

```{r, echo = T, eval=T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = 2, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "time",
                                              id = "trackID",
                                              clid = "clTrackID"),
                                inPosCols = c("x", "y"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myImPlot(dtRes,
          inFillVar = "clTrackID",
          inFillName = "Cluster",
          inFillPal = "Tableau 10",
          inXlim = c(min(dtIn$x), max(dtIn$x)),
          inYlim = c(max(dtIn$y), min(dtIn$y)))
```

```{r, echo = F, results="asis", eval = T}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "exp02/dmd-exp02_out.csv", 
       inDir = "testImagePatterns")
```

## Exp 03

A moving doughnut.

```{r,echo=T, eval=T, fig.width=6, fig.height=5}
dtIn = myImLoad("exp03/png")

myImPlot(dtIn)
```

```{r, echo = T, eval=T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = 2, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "time",
                                              id = "trackID",
                                              clid = "clTrackID"),
                                inPosCols = c("x", "y"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myImPlot(dtRes,
          inFillVar = "clTrackID",
          inFillName = "Cluster",
          inFillPal = "Tableau 10",
          inXlim = c(min(dtIn$x), max(dtIn$x)),
          inYlim = c(max(dtIn$y), min(dtIn$y)))
```

```{r, echo = F, results="asis", eval=T}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "exp03/dmd-exp03_out.csv", 
       inDir = "testImagePatterns")
```


## Exp 04

Detection and tracking of 4 moving clusters.

```{r,echo=T, eval=T, fig.width=6, fig.height=5}
dtIn = myImLoad("exp04/png")

myImPlot(dtIn)
```

```{r, echo = T, eval=T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = 2, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "time",
                                              id = "trackID",
                                              clid = "clTrackID"),
                                inPosCols = c("x", "y"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myImPlot(dtRes,
          inFillVar = "clTrackID",
          inFillName = "Cluster",
          inFillPal = "Tableau 10",
          inXlim = c(min(dtIn$x), max(dtIn$x)),
          inYlim = c(max(dtIn$y), min(dtIn$y)))
```

```{r, echo = F, results="asis", eval = T}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "exp04/dmd-exp04_out.csv", 
       inDir = "testImagePatterns")
```

## Exp 05

Detection and tracking of a concentrically growing cluster.

```{r,echo=T, eval=T, fig.width=6, fig.height=5}
dtIn = myImLoad("exp05/png")

myImPlot(dtIn)
```

```{r, echo = T, eval=T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = 2, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "time",
                                              id = "trackID",
                                              clid = "clTrackID"),
                                inPosCols = c("x", "y"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myImPlot(dtRes,
          inFillVar = "clTrackID",
          inFillName = "Cluster",
          inFillPal = "Tableau 10",
          inXlim = c(min(dtIn$x), max(dtIn$x)),
          inYlim = c(max(dtIn$y), min(dtIn$y)))
```

```{r, echo = F, results="asis", eval = T}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "exp05/dmd-exp05_out.csv", 
       inDir = "testImagePatterns")
```

## Exp 06

Detection and tracking of a single cluster moving on an ellipse.

```{r,echo=T, eval=T, fig.width=6, fig.height=5}
dtIn = myImLoad("exp06/png")

myImPlot(dtIn)
```

```{r, echo = T, eval=T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = 2, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "time",
                                              id = "trackID",
                                              clid = "clTrackID"),
                                inPosCols = c("x", "y"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myImPlot(dtRes,
          inFillVar = "clTrackID",
          inFillName = "Cluster",
          inFillPal = "Tableau 10",
          inXlim = c(min(dtIn$x), max(dtIn$x)),
          inYlim = c(max(dtIn$y), min(dtIn$y)))
```

```{r, echo = F, results="asis", eval = T, fig.width=6, fig.height=5}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "exp06/dmd-exp06_out.csv", 
       inDir = "testImagePatterns")
```

## Exp 07

Detection and tracking of a single cluster that splits.

```{r,echo=T, eval=T, fig.width=6, fig.height=5}
dtIn = myImLoad("exp07/png")

myImPlot(dtIn)
```

```{r, echo = T, eval=T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = 2, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "time",
                                              id = "trackID",
                                              clid = "clTrackID"),
                                inPosCols = c("x", "y"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myImPlot(dtRes,
          inFillVar = "clTrackID",
          inFillName = "Cluster",
          inFillPal = "Tableau 10",
          inXlim = c(min(dtIn$x), max(dtIn$x)),
          inYlim = c(max(dtIn$y), min(dtIn$y)))
```

```{r, echo = F, results="asis", eval = T, fig.width=6, fig.height=5}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "exp07/dmd-exp07_out.csv", 
       inDir = "testImagePatterns")
```

## Exp 08

Detection and tracking of 3 rotating clusters..

```{r,echo=T, eval=T, fig.width=6, fig.height=5}
dtIn = myImLoad("exp08/png")

myImPlot(dtIn)
```

```{r, echo = T, eval=T, fig.width=6, fig.height=5}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = 2, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "time",
                                              id = "trackID",
                                              clid = "clTrackID"),
                                inPosCols = c("x", "y"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myImPlot(dtRes,
          inFillVar = "clTrackID",
          inFillName = "Cluster",
          inFillPal = "Tableau 10",
          inXlim = c(min(dtIn$x), max(dtIn$x)),
          inYlim = c(max(dtIn$y), min(dtIn$y)))
```

```{r, echo = F, results="asis", eval = T, fig.width=6, fig.height=5}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "exp08/dmd-exp08_out.csv", 
       inDir = "testImagePatterns")
```

## Exp 09

Detection and tracking of a single cluster moving on an ellipse.

Same as **Exp 06** but more frames. 

```{r,echo=T, eval=T, fig.width=6, fig.height=6}
dtIn = myImLoad("exp09/png")

myImPlot(dtIn)
```

```{r, echo = T, eval=T, fig.width=6, fig.height=6}
dtColl = ARCOS::trackCollEvents(inDT = dtIn[m>0], 
                                inEps = 2, 
                                inMinPts = 1L, 
                                inNprev = 1L, 
                                inCols = list(frame = "time",
                                              id = "trackID",
                                              clid = "clTrackID"),
                                inPosCols = c("x", "y"),
                                inDeb = F)

dtRes = merge(dtIn,
              dtColl,
              by = c("time", "trackID"))

myImPlot(dtRes,
          inFillVar = "clTrackID",
          inFillName = "Cluster",
          inFillPal = "Tableau 10",
          inXlim = c(min(dtIn$x), max(dtIn$x)),
          inYlim = c(max(dtIn$y), min(dtIn$y)))
```

```{r, echo = F, results="asis", eval = T, fig.width=6, fig.height=5}
myTest(dtColl[,
              .(time, trackID, clTrackID)],
       "exp09/dmd-exp09_out.csv", 
       inDir = "testImagePatterns")
```

